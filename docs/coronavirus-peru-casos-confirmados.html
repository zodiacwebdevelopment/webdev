<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>COVID-19 en Perú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="favicons/coronavirushd.ico">
  <link rel="stylesheet" href="font-awesome/css/all.css">
  <style type="text/css">
  	*{
  	margin: 0;
  	padding: 0;
  	box-sizing: border-box;
  	font-family: sans-serif;
  	}
  	
  	html{font-size: 100%;}
  	
  	.container{width: 100%; }
  	
  	.chart{margin-bottom: 1rem;}
  	
  	h1{margin: 1rem auto;}
  	
  	.p{
  	margin: 0 2rem 2rem;
  	font-size: .7rem;
  	display: flex;
  	justify-content: space-between;
  	}

span{
font-weight: bold;
}
  	
  	.pred1{color: #28a745;}
  	
  	.pred2{color: #007bff;}
  	
  	.preddead{color: #dc3545;}
  	
  	.predrecovered{color: #17a2b8;}
  	
  	a{
  	text-decoration: none;
  	color: #007bff;
  	}
  	
  	.download{
  	padding: 10px;
  	width: 50%;
  	margin: auto;
  	text-align: center;
  	color: white;
  	background: #007bff;
  	box-sizing: border-box;
  	border-radius: 5px;
  	font-family: sans-serif;
  	}
  	
  	form{
  	margin-bottom: 2rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	.number{
  	padding: 8px;
  	border: 1px solid #bbb;
  	border-radius: 6px;
  	margin-bottom: .5rem;
  	}
  	
  	.btn{
  	padding: 10px;
  	text-align: center;
  	color: white;
  	background: #007bff;
  	border-radius: 5px;
  	font-family: sans-serif;
  	margin-bottom: .5rem;
  	}
  	
  	.globalp{
  	display: flex;
  	align-items: center;
  	justify-content: center;
  	font-size: .9rem;
  	margin-bottom: 2rem;
  	}
  	
  	footer{
  	background: #111 ;
  	color: #ddd;
  	padding: 1rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	footer h1{
  	margin: 1rem 0;
  	font-size: 1.5rem;
  	}
  	
  	footer p{
  	font-size: .8rem;
  	line-height: 1.2rem;
  	}
  	
  	.contacto {
  	display: flex;
  	padding: .5rem;
  	height: 3rem;
  	}
  	
  	.right{text-align: right;}
  	
  	.center{text-align: center;}
  	
  	.contacto i {
  	font-size: 1.5rem;
  	color: #6c757d;
  	margin-right: 2rem;
  	}
  	
  	.contacto i:hover{
  	color: white;
  	font-size: 1.7rem;
  	}
  	
  	footer h3{
  	font-size: .5rem;
  	color: #6c757d;
  	align-self: center;
  	margin: 1rem 0 0 0;
  	}
  	
  	@media (min-width: 720px){
  	body{
  		background: #ffc107;
  		display: flex;
  		flex-direction: column;
  		align-items: center;
  		justify-content: space-between;
  	}
  	
  	form{margin: 0;}
  	
  	footer{
  	padding: 3rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	.container{
  		width: 80%;
  		background: white;
  		font-size: 24px;
  		padding: 20px;
  		border-radius: 10px;
  		margin: 10px 0;
  		box-shadow: 0 0 20px 0 rgba(0,0,0,0.2);
  	}
  	
  	.p div p{font-size: .8rem;}
  	
  	.btn {margin: 0;}
  	
  	.contacto{height: 7rem;}
  	
  	.contacto i{
  	font-size: 3.5rem;
  	margin: 2rem;
  	}
  	
  	footer h3{
  	margin-bottom: -2rem;
  	align-self: center;
  	}
  	}
  </style>
</head>

<body>
<h1>COVID-19 en Perú</h1>
<div class="container">
<div class="chart">
	<canvas id="myChart" width="400" height="400"></canvas>
</div>
<div class="p">
    <div>
	    <p><span id="hoy"></span> (día <span id="dia"></span>):</p>
	    <p>Total infectados: <span class="pred2" id="totala"></span></p>
        <p>Nuevos infectados: <span class="pred1" id="nuevosa"></span></p>
    </div>
    <div class="right">
        <p>Predicciones para <span id="mañana"></span>:</p>
		<p>Nuevos infectados: <span class="pred1" id="nuevos"></span></p>
		<p>Total infectados: <span class="pred2" id="total"></span></p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-infected-chart-peru" id="descargar">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div class="chart">
	<canvas id="deathChart" width="400" height="400"></canvas>
</div>
<div class="p">
	<div>
	    <p>Total fallecidos: <span class="preddead" id="deada"></span></p>
	</div>
	<div class="right">
		<p>Tasa de letalidad: <span class="preddead" id="tasam"></span>%</p>
	</div>
</div>
<form name="form">
	<a class="download" download="covid19-dead-chart-peru" id="descargar1">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div class="chart">
	<canvas id="recoveredChart" width="400" height="400"></canvas>
</div>
<div class="p">
    <div>
	    <p>Total recuperados: <span class="predrecovered" id="recovereda"></span></p>
    </div>
    <div class="right">
    	<p>Tasa de recuperación: <span class="predrecovered" id="tasar"></span>%</p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-recovered-chart-peru" id="descargar2">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div>
	<canvas class="chart" id="regionesChart" width="480" height="720"></canvas>
</div>
<div class="p">
    <div class="center">
	    <p>*En <span id="mayorCasos"></span> y <span id="callao"></span> se encuentran la mayor cantidad de infectados (<span id="lima"></span> y <span id="totalCallao"></span>, respectivamente), con esa cantidad en el gráfico no sería posible distinguir los datos de los otros departamentos. Por eso no ha sido incluida en él.</p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-por-departamento-chart-peru" id="descargar3">Guardar gráfico</a>
</form>
</div>
<div class="globalp">
	<p>Gráficos basados en datos del <a href="https://covid19.minsa.gob.pe/sala_situacional.asp" target="_blank">MINSA</a></p>
</div>	
<footer>
	<h1>Acerca de</h1>
	<p>
		Los gráficos fueron hechos con Chart.js (una librería de javascript) y con información pública recopilada de la página web del MINSA. 
		Por ello, está libre de derechos de autor y puede ser usada libremente. El propósito de esta página no es el de alarmar a la población, sino
		 ofrecer información clara y de manera objetiva para estar al tanto de la situación actual del Perú.
	</p>
	<h1>Quiénes somos</h1>
	<p>
		Soy un estudiante de ingeniería ambiental y sanitaria, amante de la estadística y que en sus ratos libres desarrolla páginas web.
	</p>
	<h1>Contáctame</h1>
	<div class="contacto">
		<a href="https://www.facebook.com/axelsteven.sifuentespalacios" target="_blank"><i class="fab fa-facebook-f"></i></a>
		<a href="https://api.whatsapp.com/send?phone=51986173780" target="_blank"><i class="fab fa-whatsapp"></i></a>
	    <a href="mailto:steven.tauro2000.b@gmail.com" target="_blank"><i class="fab fa-google"></i></a>
	</div>
	<h3>Zodiacwebdevelopment 2020</h3>
</footer>
	<script src="chart/Chart.min.js"></script>
	<script>
         async function getData(){
         	function Departamento(nombre, casos){
         	this.nombre = nombre;
         	this.casos = casos;
         	}
         	
         	let infected      = [],
         	    dead          = [],
         	    recuperados   = [],
         	    fechas        = [],
         	    departamentos = [];
         	const response = await fetch('csv/confirmados.csv');
         	const regiones = await fetch('csv/departamentos.csv');
         	const data = await response.text();
         	const dep = await regiones.text();
         	const table = data.split('\n').slice(1);
         	const deprow = dep.split('\n');
         	table.forEach(element => {
         		if(element){
         		const col = element.split(',');
         		const f = col[0];
         		const val = col[1];
         		const d = col[2];
         		const r = col[3]*1;
         		if(val) infected.push(parseInt(val));
         		if(d) dead.push(parseInt(d));
         		fechas.push(f);
         		if(r) recuperados.push(parseInt(r));
         		}
         	});
         	deprow.forEach(item => {
         		if(item){
         		const depcols = item.split(',');
         		const names = depcols[0];
         		const cases = depcols[depcols.length-1];
         		departamentos.push(new Departamento(names, parseInt(cases)));
         		}
         	}); 
         	return {infected, dead, recuperados, departamentos, fechas};
         }
        
         function acumular(array){
		 	let nuevos = [];
		 	let cumulo = 0;
		 	for(let i=0; i<array.length; i++){
		 		cumulo += array[i];
				nuevos.push(cumulo);
		 	}
		 	return nuevos;
		 }
		 
		 function tasa(array,infect){
		 	let ratio = 0;
		 	let num = array[array.length-1]/acumular(infect)[infect.length-1];
		 	ratio = num * 100;
		 	return ratio;
		 }
		 
		 function ordenarRegiones(regiones){
		 	let nombre = [];
		 	let casos = [];
		 	regiones.sort(function(prev, next){
		 		return next.casos - prev.casos;
		 	});
		 	for(let i=0; i<regiones.length; i++){
		 		nombre[i] = regiones[i].nombre;
		 		casos[i] = regiones[i].casos;
		 	}
		 	return {x: casos,y: nombre};
		 }
		 
		 function downloadCanvas(ancla, chart){
		 	let canvasurl = document.getElementById(chart).toDataURL("image/jpeg", 1.0);
		 	ancla.setAttribute("href", canvasurl);
		 }
		 
		 function crearDias(len,a){
		 	let dias = [];
		 	if(!a) a = 0;
		 	for(let i=a; i<len; i++){
		 		dias.push(i+1);
		 	}
		 	return dias;
		 }

                 function calcActive(infected,dead,recovered){
let sum = 0;
let dif = 0;
let arrayActive = [];
let activos = 0;
for(let i=0; i<infected.length; i++){
if(i>=9) dif = recovered[i] - recovered[i-1];
sum+=infected[i];
activos = sum - dead[i] - dif;
arrayActive.push(parseInt(activos));
}
return arrayActive;
}

         function regresionLineal(array, futuro){
			 let a     = 0, 
				 b     = 0,
				 n     = array.length,
				 sumx  = 0,
				 sumy  = 0,
				 sumxy = 0,
				 sumxx = 0;
			 
			 for(let i=0; i<n; i++){
				 sumx  += i;
				 sumy  += array[i];
				 sumxy += i*array[i];
				 sumxx += i*i;
			 }
				 
			 b = (sumx*sumy - n*sumxy)/(sumx*sumx - n*sumxx);
			 a = (sumy - b*sumx)/n;
			 return a + b*futuro;
		 }

         function regresionExponencial(array, futuro){
			 let a       = 0,
				 b       = 0,
				 n       = array.length,
				 mlny    = 0,
				 mx      = 0,
				 sumx    = 0,
				 sumxx   = 0,
				 sumxlny = 0;
			 
			 for(let i=0; i<n; i++){
				 mlny    += Math.log(array[i]);
				 sumx    += i;
				 sumxx   += i*i;
				 sumxlny += i*Math.log(array[i]);
			 }
			 
			 mx   = sumx/n;
			 mlny = mlny/n;
			 b = (sumxlny - mlny*sumx)/(sumxx - mx*sumx);
			 a = Math.pow(Math.E,(mlny - b*mx));
			 return a*Math.pow(Math.E,b*futuro);
		 }
			 		 
		 Chart.plugins.register({
			 beforeDraw: function(chartInstance) {
			 var ctx = chartInstance.chart.ctx;
				 ctx.fillStyle = "white";
				 ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
			 }
		 });
		 
		 var ctx  = document.getElementById('myChart').getContext('2d'),
		       ctx2 = document.getElementById('deathChart').getContext('2d'),
		       ctx3 = document.getElementById('recoveredChart').getContext('2d'),
		       ctx4 = document.getElementById('regionesChart').getContext('2d');
		 
		 chartIt()
		 
		 async function chartIt(){
		 const data = await getData();
		 var myChart = new Chart(ctx, { 
		 	type: 'line', 
			 data: { 
			 	labels: crearDias(data.infected.length), 
			 	datasets: [{ 
			 		label: 'Total de casos', 
					data: acumular(data.infected),
			 		fill: false,
			 		lineTension: 0,
			 		backgroundColor: [ 'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)' ], 
			 		borderColor: 'rgba(54, 162, 235, 1)', 
			 		borderWidth: 2,
			 		pointRadius: 1
			 		 },{
			 		label: 'Nuevos casos',
			 		data: data.infected,
			 		fill: false,
			 		lineTension: 0,
			 		borderWidth: 2,
			 		borderColor: 'rgb(0,255,0)',
			 		pointRadius: 1
			 		},{
label: 'Casos activos',
data: calcActive(data.infected,data.dead,data.recuperados),
fill: false,
lineTension: 0,
borderWidth: 2,
pointRadius: 1,
borderColor: '#6f42c1'
}
			 	]}, 
			 	options: { 
			 		title: {
			 			display: true,
			 			text: "Casos confirmados",
			 			fontSize: 18
			 		},
			 		scales: { 
			 			xAxes: [{ 
			 				ticks: { 
			 					beginAtZero: false,
			 					 callback: function(value, index, values) {
			 					 return 'dia ' + value;
			 					 }} 
			 				}] 
			 			} 
			 		} 
			 	});
		
		var deathChart = new Chart(ctx2, {
			type: "line",
			data: {
				labels: crearDias(data.dead.length,13),
				datasets: [{
                                        label: 'Total fallecidos',
					data: acumular(data.dead.slice(13)),
					fill: false,
					lineTension: 0,
					borderColor: '#dc3545', 
					borderWidth: 2,
					pointRadius: 1
				},{
                                        label: "Nuevas muertes",
data: data.dead.slice(13),
fill: false,
lineTension: 0,
borderColor: "#fd7e14",
borderWidth: 2,
pointRadius: 1
                                }]
			},
			options: {
				title: {
					display: true,
					text: "Muertes confirmadas",
					fontSize: 18
				},
				legend:{
					display: true
				},
				scales: {
					xAxes: [{
						ticks: {
							beginAtZero: true,
							callback: function(value, index, values) {
								return 'dia ' + value;
							}
						}
					}]
				}
			}
		});
		
		var recoveredChart = new Chart(ctx3, {
			type: 'line',
			data: {
				labels: crearDias(data.recuperados.length+9,9),
				datasets: [{
					data: data.recuperados,
					fill: false,
					lineTension: 0,
					borderColor: '#17a2b8', 
					borderWidth: 2,
					pointRadius: 2
					
				}]
			},
			options: {
				title: {
					display: true,
					text: "Casos recuperados",
					fontSize: 18
				},
				legend:{
					display: false
				},
				scales: {
					xAxes: [{
						ticks: {
							beginAtZero: true,
							callback: function(value, index, values) {
								return 'dia ' + value;
							}
						}
					}]
				}
			}
		});
		
		var regionesChart = new Chart(ctx4, {
			type: "horizontalBar",
			data:{
			labels: ordenarRegiones(data.departamentos).y.slice(2),
			datasets:[{
				data: ordenarRegiones(data.departamentos).x.slice(2),
				backgroundColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)','rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)','rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)','rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)']
			}]
			},
			options: {
				title: {
					display: true,
					text: "Casos por departamento*",
					fontSize: 21
				},
				legend: {
					display: false
				},
				"hover": {
				"animationDuration": 0
				},
				"animation": {
				"duration": 1,
				"onComplete": function() {
				var chartInstance = this.chart,
				ctx = chartInstance.ctx;
				
				ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
				ctx.textAlign = 'start';
				ctx.textBaseline = 'top';
				
				this.data.datasets.forEach(function(dataset, i) {
				var meta = chartInstance.controller.getDatasetMeta(i);
				meta.data.forEach(function(bar, index) {
				var data = dataset.data[index];
				ctx.fillText(data, bar._model.x+5, bar._model.y-5);
				});
				});
				}
				}
			}
		});
		}
		
		const a = document.getElementById("descargar"),
		      b = document.getElementById("descargar1"),
		      c = document.getElementById("descargar2"),
		      d = document.getElementById("descargar3");
		
		a.addEventListener("click", function(){
			let canvasurl = document.getElementById("myChart").toDataURL("image/jpeg", 1.0);
			a.setAttribute("href", canvasurl);
		});
		b.addEventListener("click", function(){
			let canvasurl = document.getElementById("deathChart").toDataURL("image/jpeg", 1.0);
			b.setAttribute("href", canvasurl);
		});
		c.addEventListener("click", function(){
			let canvasurl = document.getElementById("recoveredChart").toDataURL("image/jpeg", 1.0);
			c.setAttribute("href", canvasurl);
		});
		d.addEventListener("click", function(){
			let canvasurl = document.getElementById("regionesChart").toDataURL("image/jpeg", 1.0);
			d.setAttribute("href", canvasurl);
		});

	writeIt();
	async function writeIt(){
		const info = await getData();
		total.innerHTML      = Math.round(acumular(info.infected)[info.infected.length-1]+regresionLineal(info.infected,info.infected.length));
		nuevos.innerHTML     = Math.round(regresionLineal(info.infected,info.infected.length));
        deada.innerHTML      = acumular(info.dead)[info.dead.length - 1];
        recovereda.innerHTML = info.recuperados[info.recuperados.length-1];
        totala.innerHTML     = acumular(info.infected)[info.infected.length-1];
        nuevosa.innerHTML    = info.infected[info.infected.length-1];
        tasar.innerHTML      = tasa(info.recuperados,info.infected).toFixed(2);
        tasam.innerHTML      = tasa(acumular(info.dead),info.infected).toFixed(2);
		mayorCasos.innerHTML = ordenarRegiones(info.departamentos).y[0];
		lima.innerHTML = ordenarRegiones(info.departamentos).x[0];
		totalCallao.innerHTML = ordenarRegiones(info.departamentos).x[1];

dia.innerHTML = info.infected.length;
		callao.innerHTML = ordenarRegiones(info.departamentos).y[1];
hoy.innerHTML = info.fechas[info.infected.length-1];
		mañana.innerHTML = info.fechas[info.infected.length];
	}
	</script>
</body>
</html>
