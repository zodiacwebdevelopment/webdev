<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>COVID-19 en Perú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="">
  <link rel="shortcut icon" href="favicons/coronavirushd.ico">
  <link rel="stylesheet" href="font-awesome/css/all.css">
  <!--<link rel="stylesheet" href="infected.css">-->
  <style type="text/css">
  	*{
  	margin: 0;
  	padding: 0;
  	box-sizing: border-box;
  	font-family: sans-serif;
  	}
  	
  	html{
  	font-size: 100%;
  	}
  	
  	.container{
  		width: 100%;
  	}
  	
  	.chart{
  	margin-bottom: 1rem;
  	}
  	
  	h1{
  	margin: 1rem auto;
  	}
  	
  	.p{
  	margin: 0 2rem 2rem;
  	font-size: .7rem;
  	display: flex;
  	justify-content: space-between;
  	}
  	
  	.pred1{color: #28a745;}
  	
  	.pred2{color: #007bff;}
  	
  	.preddead{color: #dc3545;}
  	
  	.predrecovered{color: #17a2b8;}
  	
  	a{
  	text-decoration: none;
  	color: #007bff;
  	}
  	
  	.download{
  	padding: 10px;
  	width: 50%;
  	margin: auto;
  	text-align: center;
  	color: white;
  	background: #007bff;
  	box-sizing: border-box;
  	border-radius: 5px;
  	font-family: sans-serif;
  	}
  	
  	form{
  	margin-bottom: 2rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	.number{
  	padding: 8px;
  	border: 1px solid #bbb;
  	border-radius: 6px;
  	margin-bottom: .5rem;
  	}
  	
  	.btn{
  	padding: 10px;
  	text-align: center;
  	color: white;
  	background: #007bff;
  	border-radius: 5px;
  	font-family: sans-serif;
  	margin-bottom: .5rem;
  	}
  	
  	.globalp{
  	display: flex;
  	align-items: center;
  	justify-content: center;
  	font-size: .9rem;
  	margin-bottom: 2rem;
  	}
  	
  	footer{
  	background: #111 ;
  	color: #ddd;
  	padding: 1rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	footer h1{
  	margin: 1rem 0;
  	font-size: 1.5rem;
  	}
  	
  	footer p{
  	font-size: .8rem;
  	line-height: 1.2rem;
  	}
  	
  	.contacto {
  	display: flex;
  	padding: .5rem;
  	height: 3rem;
  	}
  	
  	.contacto i {
  	font-size: 1.5rem;
  	color: #6c757d;
  	margin-right: 2rem;
  	}
  	
  	.contacto i:hover{
  	color: white;
  	font-size: 1.7rem;
  	}
  	
  	footer h3{
  	font-size: .5rem;
  	color: #6c757d;
  	align-self: center;
  	margin: 1rem 0 0 0;
  	}
  	
  	@media (min-width: 720px){
  	p{
  	font-size: 1rem;
  	}
  	
  	footer{
  	padding: 3rem;
  	display: flex;
  	flex-direction: column;
  	}
  	
  	.contacto{
  	height: 7rem;
  	}
  	
  	.contacto i{
  	font-size: 3.5rem;
  	margin: 2rem;
  	}
  	
  	footer h3{
  	margin-bottom: -2rem;
  	align-self: center;
  	}
  	}
  </style>
</head>

<body>
<h1>COVID-19 en Perú</h1>
<div class="container">
<div>
	<canvas class="chart" id="myChart" width="400" height="400"></canvas>
</div>
<div class="p">
    <div>
	    <p>Abril 2 (día 28):</p>
	    <p>Total infectados: <span class="pred2" id="totala"></span></p>
        <p>Nuevos infectados: <span class="pred1" id="nuevosa"></span></p>
    </div>
    <div>
        <p>Predicciones para abril 3:</p>
		<p>Nuevos infectados: <span class="pred1" id="nuevos"></span></p>
		<p>Total infectados: <span class="pred2" id="total"></span></p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-infected-chart-peru" id="descargar">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div>
	<canvas class="chart" id="deathChart" width="400" height="400"></canvas>
</div>
<div class="p">
	<div>
	    <p>Total fallecidos: <span class="preddead" id="deada"></span></p>
	</div>
	<div>
		<p>Tasa de mortalidad: <span class="preddead" id="tasam"></span>%</p>
	</div>
</div>
<form name="form">
	<a class="download" download="covid19-dead-chart-peru" id="descargar1">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div>
	<canvas class="chart" id="recoveredChart" width="400" height="400"></canvas>
</div>
<div class="p">
    <div>
	    <p>Total recuperados: <span class="predrecovered" id="recovereda"></span></p>
    </div>
    <div>
    	<p>Tasa de recuperación: <span class="predrecovered" id="tasar"></span>%</p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-recovered-chart-peru" id="descargar2">Guardar gráfico</a>
</form>
</div>
<div class="container">
<div>
	<canvas class="chart" id="regionesChart" width="480" height="720"></canvas>
</div>
<div class="p">
    <div>
	    <p>*En Lima se encuentra la mayor cantidad de infectados (1059 hasta la fecha), con esa cantidad en el gráfico no sería posible distinguir los datos de los otros departamentos. Por eso no ha sido incluida en él.</p>
    </div>
</div>
<form name="form">
	<a class="download" download="covid19-por-departamento-chart-peru" id="descargar3">Guardar gráfico</a>
</form>
</div>
<div class="globalp">
	<p>Gráficos basados en datos del <a href="https://www.gob.pe/minsa/" target="_blank">MINSA</a></p>
</div>	
<footer>
	<h1>Acerca de</h1>
	<p>
		Los gráficos fueron hechos con Chart.js (una librería de javascript) y con información pública recopilada de la página web del MINSA. 
		Por ello, está libre de derechos de autor y puede ser usada libremente. El propósito de esta página no es el de alarmar a la población, sino
		 ofrecer información clara y de manera objetiva para estar al tanto de la situación actual del Perú.
	</p>
	<h1>Quiénes somos</h1>
	<p>
		Soy un estudiante de ingeniería ambiental y sanitaria, amante de la estadística y que en sus ratos libres desarrolla páginas web.
	</p>
	<h1>Contáctame</h1>
	<div class="contacto">
		<a href="https://www.facebook.com/axelsteven.sifuentespalacios" target="_blank"><i class="fab fa-facebook-f"></i></a>
		<a href="https://api.whatsapp.com/send?phone=51986173780" target="_blank"><i class="fab fa-whatsapp"></i></a>
	    <a href="mailto:steven.tauro2000.b@gmail.com" target="_blank"><i class="fab fa-google"></i></a>
	</div>
	<h3>Zodiacwebdevelopment 2020</h3>
</footer>
	<script src="chart/Chart.min.js"></script>
	<script type="text/javascript">
         function diferencia(array){
		 	let nuevos = []
		 	for(let i=0; i<array.length; i++){
		 		if(array[i-1]){
		 			nuevos.push(array[i]-array[i-1]);
		 		}
		 		else nuevos.push(array[i]);
		 	}
		 	return nuevos;
		 }
		 
		 function tasa(array){
		 	let ratio = 0;
		 	let num = array[array.length-1]/infected[infected.length-1];
		 	ratio = num * 100;
		 	return ratio;
		 }
		 
		 function getRandomColor(array) {
			 var num=(Math.floor(Math.random()*4)*4).toString(16);
			 var letters = ['0','F',num];
			 var color = '#';
			 
			 for (var i = 0; i < 3; i++ ) {
				 let pos=Math.floor(Math.random() * letters.length);
				 color += letters[pos];
				 letters.splice(pos,1);
			 }
			 
			 //para evitar que se repitan colores 
			 if(array.includes(color))
			 return getRandomColor(array);
			 else
			 array.push(color)
		 }
		 
		 function crearColores(len){
		 	let colors = [];
		 	for(i=0; i<len; i++){
		 		getRandomColor(colors);
		 	}
		 	return colors;
		 }
		 
		 function ordenarRegiones(){
		 	let nombre = [];
		 	let casos = [];
		 	regiones.sort(function(prev, next){
		 		return next.casos - prev.casos;
		 	});
		 	for(let i=0; i<regiones.length; i++){
		 		nombre[i] = regiones[i].nombre;
		 		casos[i] = regiones[i].casos;
		 	}
		 	return {x: casos,
		 		    y: nombre};
		 }
		 
		 function downloadCanvas(ancla, chart){
		 	let canvasurl = document.getElementById(chart).toDataURL("image/jpeg", 1.0);
		 	ancla.setAttribute("href", canvasurl);
		 }
		 
		 function crearDias(len){
		 	let dias = [];
		 	for(let i=0; i<len; i++){
		 		dias[i] = i+1;
		 	}
		 	return dias;
		 }

         function regresionLineal(array, futuro){
			 let a     = 0, 
				 b     = 0,
				 n     = array.length,
				 sumx  = 0,
				 sumy  = 0,
				 sumxy = 0,
				 sumxx = 0;
			 
			 for(let i=0; i<n; i++){
				 sumx  += i;
				 sumy  += array[i];
				 sumxy += i*array[i];
				 sumxx += i*i;
			 }
				 
			 b = (sumx*sumy - n*sumxy)/(sumx*sumx - n*sumxx);
			 a = (sumy - b*sumx)/n;
			 return a + b*futuro;
		 }

         function regresionExponencial(array, futuro){
			 let a       = 0,
				 b       = 0,
				 n       = array.length,
				 mlny    = 0,
				 mx      = 0,
				 sumx    = 0,
				 sumxx   = 0,
				 sumxlny = 0;
			 
			 for(let i=0; i<n; i++){
				 mlny    += Math.log(array[i]);
				 sumx    += i;
				 sumxx   += i*i;
				 sumxlny += i*Math.log(array[i]);
			 }
			 
			 mx   = sumx/n;
			 mlny = mlny/n;
			 b = (sumxlny - mlny*sumx)/(sumxx - mx*sumx);
			 a = Math.pow(Math.E,(mlny - b*mx));
			 return a*Math.pow(Math.E,b*futuro);
		 }

		 var infected    = [1 , 6 , 7 , 9 , 11 , 17 , 22 , 38 , 46 , 71 , 86 , 117 , 145 , 234 , 263 , 318 , 363 , 395 , 416, 480 , 580 , 635, 671, 852, 950, 1065, 1323, 1414],
		     recuperados = [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,4,4,14,16,16,16,269,394,447,537],
		     dead        = [0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,5,5,5,7,9,9,11,16,18,24,30,47,47],
		     regiones    = [//{nombre: "Lima", casos:1059 },
		     				{nombre: "Loreto", casos:72},
		     				{nombre: "Callao", casos:40 },
		     				{nombre: "Lambayeque", casos:37 },
		     				{nombre: "Piura", casos:27 },
		     				{nombre: "Cusco", casos:38 },
		     				{nombre: "Arequipa", casos:30 },
		     				{nombre: "Junín", casos:17 },
		     				{nombre: "La Libertad", casos:34 },
		     				{nombre: "Tumbes", casos:15},
		     				{nombre: "Ancash", casos:15 },
		     				{nombre: "Ica", casos:8 },
		     				{nombre: "Huánuco", casos:6 },
		     				{nombre: "San Martín", casos:6 },
		     				{nombre: "Ayacucho", casos:1 },
		     				{nombre: "Cajamarca", casos:3},
		     				{nombre: "Madre de Dios", casos:1 },
		     				{nombre: "Tacna", casos:3 },
		     				{nombre: "Huancavelica", casos:1 },
		     				{nombre: "Pasco", casos:1 }],     
		     labels      = ['marzo 6','marzo 7','marzo 8','marzo 9','marzo 10','marzo 11','marzo 12','marzo 13','marzo 14','marzo 15','marzo 16','marzo 17','marzo 18','marzo 19','marzo 20','marzo 21','marzo 22', 'marzo 23', 'marzo 24','marzo 25','marzo 26','marzo 27','marzo 28','marzo 29','marzo 30','marzo 31','abril 1'];
			 
		 Chart.plugins.register({
			 beforeDraw: function(chartInstance) {
			 var ctx = chartInstance.chart.ctx;
				 ctx.fillStyle = "white";
				 ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
			 }
		 });
		 
		 
		 var ctx  = document.getElementById('myChart').getContext('2d'),
		       ctx2 = document.getElementById('deathChart').getContext('2d'),
		       ctx3 = document.getElementById('recoveredChart').getContext('2d'),
		       ctx4 = document.getElementById('regionesChart').getContext('2d');
		 	
		 /*Chart.plugins.register({
		 beforeDraw: function(chartInstance) {
		 var ctx = chartInstance.chart.ctx;
		 ctx.fillStyle = "#ffffff";
		 ctx.fillRect(0, 0, chartInstance.chart.width, chartInstance.chart.height);
		 }
		 });*/
		 
		 var myChart = new Chart(ctx, { 
		 	type: 'line', 
			 data: { 
			 	labels: crearDias(infected.length), 
			 	datasets: [{ 
			 		label: 'Total de casos', 
					data: infected,
			 		fill: false,
			 		lineTension: 0,
			 		backgroundColor: [ 'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)' ], 
			 		borderColor: 'rgba(54, 162, 235, 1)', 
			 		borderWidth: 2,
			 		pointRadius: 2
			 		 },{
			 		label: 'Nuevos casos',
			 		data: diferencia(infected),
			 		fill: false,
			 		lineTension: 0,
			 		borderWidth: 2,
			 		borderColor: 'rgb(0,255,0)',
			 		pointRadius: 2
			 		}
			 	]}, 
			 	options: { 
			 		title: {
			 			display: true,
			 			text: "Casos confirmados",
			 			fontSize: 18
			 		},
			 		legend: {
						//display: false
			 		},
			 		scales: { 
			 			xAxes: [{ 
			 				ticks: { 
			 					beginAtZero: false,
			 					 callback: function(value, index, values) {
			 					 return 'dia ' + value;
			 					 }} 
			 				}] 
			 			} 
			 		} 
			 	});
		
		var deathChart = new Chart(ctx2, {
			type: "line",
			data: {
				labels: crearDias(infected.length),
				datasets: [{
					data: dead,
					fill: false,
					lineTension: 0,
					borderColor: '#dc3545', 
					borderWidth: 2,
					pointRadius: 2
				}]
			},
			options: {
				title: {
					display: true,
					text: "Muertes confirmadas",
					fontSize: 18
				},
				legend:{
					display: false
				},
				scales: {
					xAxes: [{
						ticks: {
							// Include a dollar sign in the ticks
							beginAtZero: true,
							callback: function(value, index, values) {
								return 'dia ' + value;
							}
						}
					}]
				}
			}
		});
		
		var recoveredChart = new Chart(ctx3, {
			type: 'line',
			data: {
				labels: crearDias(infected.length),
				datasets: [{
					data: recuperados,
					fill: false,
					lineTension: 0,
					borderColor: '#17a2b8', 
					borderWidth: 2,
					pointRadius: 2
					
				}]
			},
			options: {
				title: {
					display: true,
					text: "Casos recuperados",
					fontSize: 18
				},
				legend:{
					display: false
				},
				scales: {
					xAxes: [{
						ticks: {
							// Include a dollar sign in the ticks
							beginAtZero: true,
							callback: function(value, index, values) {
								return 'dia ' + value;
							}
						}
					}]
				}
			}
		});
		
		var regionesChart = new Chart(ctx4, {
			type: "horizontalBar",
			data:{
			labels: ordenarRegiones().y,
			datasets:[{
				data: ordenarRegiones().x,
				backgroundColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)','rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)','rgba(255, 99, 132, 1)' ]
				//backgroundColor: crearColores(regiones.length)
			}]
			},
			options: {
				title: {
					display: true,
					text: "Casos por departamento*",
					fontSize: 21
				},
				legend: {
					display: false
				},
				"hover": {
				"animationDuration": 0
				},
				"animation": {
				"duration": 1,
				"onComplete": function() {
				var chartInstance = this.chart,
				ctx = chartInstance.ctx;
				
				ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
				ctx.textAlign = 'start';
				ctx.textBaseline = 'top';
				
				this.data.datasets.forEach(function(dataset, i) {
				var meta = chartInstance.controller.getDatasetMeta(i);
				meta.data.forEach(function(bar, index) {
				var data = dataset.data[index];
				ctx.fillText(data, bar._model.x+5, bar._model.y-5);
				});
				});
				}
				}
			}
		});
		
		const a = document.getElementById("descargar"),
		      b = document.getElementById("descargar1"),
		      c = document.getElementById("descargar2"),
		      d = document.getElementById("descargar3");
		
		a.addEventListener("click", function(){
			let canvasurl = document.getElementById("myChart").toDataURL("image/jpeg", 1.0);
			a.setAttribute("href", canvasurl);
		});
		b.addEventListener("click", function(){
			let canvasurl = document.getElementById("deathChart").toDataURL("image/jpeg", 1.0);
			b.setAttribute("href", canvasurl);
		});
		c.addEventListener("click", function(){
			let canvasurl = document.getElementById("recoveredChart").toDataURL("image/jpeg", 1.0);
			c.setAttribute("href", canvasurl);
		});
		d.addEventListener("click", function(){
			let canvasurl = document.getElementById("regionesChart").toDataURL("image/jpeg", 1.0);
			d.setAttribute("href", canvasurl);
		});

        const total  = document.getElementById("total"),
              nuevos = document.getElementById("nuevos");

		total.innerHTML      = Math.round(infected[infected.length-1]+regresionExponencial(diferencia(infected),infected.length));
		nuevos.innerHTML     = Math.round(regresionExponencial(diferencia(infected),infected.length));
        deada.innerHTML      = dead[dead.length - 1];
        recovereda.innerHTML = recuperados[recuperados.length-1];
        totala.innerHTML     = infected[infected.length-1];
        nuevosa.innerHTML    = diferencia(infected)[infected.length-1];
        tasar.innerHTML      = tasa(recuperados).toFixed(2);
        tasam.innerHTML      = tasa(dead).toFixed(2);
	</script>
</body>
</html>
